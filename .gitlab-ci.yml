stages:
  - test
  - sonar
  - build

variables:
  SERVICE_NAME: "vue-template"
  SERVICE_CONTEXT: "."
  VERSION_FILE: "package.json"
  HARBOR_HOST: "${CI_REGISTRY}"
  SERVICE_IMAGE_TAG: "${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHORT_SHA}"
  SERVICE_LATEST_TAG: "${CI_REGISTRY_IMAGE}:latest"

# TEST STAGE
test:
  stage: test
  image: node:18-alpine
  cache:
    key: "$CI_COMMIT_REF_SLUG"
    paths:
      - node_modules/
      - .npm/
  before_script:
    - npm ci --cache .npm --prefer-offline
  script:
    - echo "Running tests..."
    - npm run test
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
    paths:
      - coverage/
    expire_in: 1 week
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "develop"'
    - if: '$CI_PIPELINE_SOURCE == "web"'

# SONAR STAGE
sonar_code_analysis:
  stage: sonar
  image: sonarsource/sonar-scanner-cli:11.4
  cache:
    policy: pull-push
    key: "sonar-cache-$CI_COMMIT_REF_SLUG"
    paths:
      - "${SONAR_USER_HOME}/cache"
      - sonar-scanner/
  script:
    - echo "Running SonarQube analysis..."
    - sonar-scanner -Dsonar.host.url="${SONAR_HOST_URL}"
  allow_failure: true
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "develop"'

# BUILD STAGE
.kaniko_build_and_push_template:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  before_script:
    - |
      if [ -n "$CI_COMMIT_TAG" ]; then
        export WATERMARK="${CI_COMMIT_TAG}"
      else
        export WATERMARK="${CI_COMMIT_BRANCH}:${CI_COMMIT_SHORT_SHA}"
      fi
    - echo "Replacing [[VERSION]] with $WATERMARK in $VERSION_FILE..."
    - |
      FILE_PATH="$SERVICE_CONTEXT/$VERSION_FILE"
      if [ -f "$FILE_PATH" ]; then
        sed -i "s|\[\[VERSION\]\]|$WATERMARK|g" "$FILE_PATH"
      else
        echo "WARNING: Version file $FILE_PATH does not exist"
      fi
  script:
    - echo "Building and pushing $SERVICE_NAME image with Kaniko..."
    - mkdir -p /kaniko/.docker
    - |
      echo "{\"auths\":{\"${HARBOR_HOST}\":{\"username\":\"${HARBOR_USERNAME}\",\"password\":\"${HARBOR_PASSWORD}\"}}}" > /kaniko/.docker/config.json
    - |
      /kaniko/executor \
        --dockerfile="build/Dockerfile" \
        --context="dir://$SERVICE_CONTEXT" \
        --build-arg VITE_KEYCLOAK_URL="${VITE_KEYCLOAK_URL}" \
        --build-arg VITE_KEYCLOAK_REALM="${VITE_KEYCLOAK_REALM}" \
        --build-arg VITE_KEYCLOAK_CLIENT_ID="${VITE_KEYCLOAK_CLIENT_ID}" \
        --build-arg VITE_APP_TITLE="${VITE_APP_TITLE}" \
        --build-arg VITE_API_BASE_URL="${VITE_API_BASE_URL}" \
        --build-arg VITE_APP_DEBUG="${VITE_APP_DEBUG:-false}" \
        --destination="$SERVICE_IMAGE_TAG" \
        --destination="$SERVICE_LATEST_TAG" \
        --skip-tls-verify-registry="${CI_REGISTRY}"
  after_script:
    - echo "Image build and push complete for $SERVICE_NAME using Kaniko."
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE != "merge_request_event"'
      when: on_success
    - if: '$CI_PIPELINE_SOURCE == "web"'
      when: on_success
    - when: never

build_and_push:
  extends: .kaniko_build_and_push_template
